---
title: "Dashboard"
format: html
---

```{r}
#| label: load_libraries
#| echo: false
#| warning: false

library(shiny)
library(ggplot2)
library(scales)
library(tidyverse)
```

```{r}
#| label: load&transform_data
#| warning: false
#| 
url <- "https://docs.google.com/spreadsheets/d/1DWcT_Qs3a71Um4I--zvMtkl1CnVuHmW05JlYs-WwS8c/edit?gid=0#gid=0"
data <- googlesheets4::read_sheet(url, col_types = "c")

long_data <- data %>% 
  select(-Owner) %>% 
  select(where(~!all(is.na(.)))) %>%
  rename(metric_name = "Metrics/ Date") %>%
  rename(target_raw = Target) %>% 
  pivot_longer(
    cols = -c(metric_name, target_raw),
    names_to = "date",  
    values_to = "value_raw" 
  ) %>%
  mutate(
    value_raw = str_replace(value_raw, ",", "."),
    target_num = parse_number(target_raw),
    value_num = parse_number(value_raw)
  ) %>% 
  select(-target_raw)
```

```{r}
#| label: setting_block

# --- Time Period Settings ---
# How many months of history to show on charts
CHART_HISTORY_MONTHS <- 6  # Change to 3 for 3 months, 12 for 1 year, etc.

# --- Block Configuration ---
# Each metric is defined as: c("Metric Name", "chart_type")
# Chart types:
#   "line"      - simple line chart
#   "line_area" - line with shaded area below
#   "card"      - KPI card with value, target, change
#   "bar"       - bar chart (for grouped metrics)
#
# Additional options (add after chart_type):
#   "lower_better" - for metrics where lower is better (e.g., Rejects, FRT)

# BLOCK 1: Key Metrics (top row of cards)
BLOCK1_METRICS <- list(
  c("Availability Average", "card"),
  c("Availability Lowest", "card"),
  c("%Completion", "card"),
  c("PU Retention", "card")
)

# BLOCK 2: Operational Metrics
BLOCK2_METRICS <- list(
  # First chart: Supply Liquidity (two lines with area between)
  list(
    title = "Supply Liquidity (Availability)",
    metrics = c("Availability Average", "Availability Lowest"),
    type = "line_area_dual",  # special type for two lines with area between
    width = 5  # column width (out of 12)
  ),
  # Second chart: Utilization
  list(
    title = "Utilization",
    metrics = c("Utilization"),
    type = "line",
    width = 4
  ),
  # Cards column
  list(
    title = NULL,  # no title for card column
    metrics = list(
      c("%Rejects", "card", "lower_better"),
      c("Headcount", "card_simple")  # card without target comparison
    ),
    type = "card_stack",
    width = 3
  )
)

# BLOCK 3: Quality & Business Metrics
BLOCK3_METRICS <- list(
  # CSAT chart (faceted)
  list(
    title = "CSAT Metrics",
    metrics = c("CSAT overall", "CSAT trial"),
    type = "line_facet",
    width = 6
  ),
  # CR Free to Paid card
  list(
    title = "CR Free to Paid",
    metrics = c("CR Free to Paid"),
    type = "card_large",
    width = 6
  ),
  # FRT chart
  list(
    title = "First Response Time (FRT)",
    metrics = c("FRT"),
    type = "line",
    lower_better = TRUE,
    width = 6
  ),
  # Positive Reviews chart
  list(
    title = "% Positive Reviews",
    metrics = c("% Positive reviews"),
    type = "line",
    width = 6
  ),
  # Communication Metrics bar chart
  list(
    title = "Communication Metrics",
    metrics = c("Pings coverage", "Messenger answer rate", "Engagement messages coverage"),
    type = "bar_grouped",
    width = 12
  )
)

# BLOCK 4: Risk Alerts
BLOCK4_METRICS <- list(
  list(
    title = "NDA & AI Violations",
    metrics = c("NDA & AI usage abuse"),
    type = "alert"
  )
)

# --- Display Settings ---
SHOW_GLOW_EFFECTS <- TRUE  # Set to FALSE to disable glow effects
```

```{r}
#| label: data_check&preparation

if(!exists("long_data")) {
  stop("Variable 'long_data' not found!\n",
       "Load data first:\n",
       "  long_data <- read.csv('your_file.csv')\n")
}

# Date conversion if needed
if(!inherits(long_data$date, "Date")) {
  suppressWarnings({
    current_year <- format(Sys.Date(), "%Y")
    if(is.character(long_data$date)) {
      long_data$date <- as.Date(paste0(long_data$date, "-", current_year), 
                                format = "%d-%b-%Y")
    } else {
      long_data$date <- as.Date(long_data$date)
    }
  })
}

# Filter data to configured time period
cutoff_date <- as.Date(seq(max(long_data$date, na.rm = TRUE), length = 2, by = paste0("-", CHART_HISTORY_MONTHS, " months"))[2])
chart_data <- long_data %>% filter(date >= cutoff_date)

# Get latest date for "Last update"
last_data_date <- max(long_data$date, na.rm = TRUE)
```

```{r}
#| label: helper_functions

# Calculate change between last two periods
calculate_change <- function(data, metric) {
  metric_data <- data %>%
    filter(metric_name == metric) %>%
    arrange(date)
  
  if(nrow(metric_data) < 2) {
    return(list(current = NA, previous = NA, change = NA, change_pct = NA, target = NA))
  }
  
  current <- tail(metric_data$value_num, 1)
  previous <- metric_data$value_num[nrow(metric_data) - 1]
  change <- current - previous
  change_pct <- ifelse(previous != 0, (change / previous) * 100, 0)
  target <- metric_data$target_num[1]
  
  return(list(
    current = current,
    previous = previous,
    change = change,
    change_pct = change_pct,
    target = target
  ))
}

# Format metric value
format_metric_value <- function(value, add_percent = TRUE, decimal = 1) {
  if(is.na(value)) return("No data")
  formatted <- round(value, decimal)
  if(add_percent) return(paste0(formatted, "%"))
  return(as.character(formatted))
}

# Get arrow icon
get_arrow_icon <- function(change) {
  if(is.na(change)) return("â†’")
  if(change > 0) return("â†‘")
  if(change < 0) return("â†“")
  return("â†’")
}

# Get change color
get_change_color <- function(change, is_higher_good = TRUE) {
  if(is.na(change)) return("#6c757d")
  if(is_higher_good) {
    if(change > 0) return("#28a745")
    if(change < 0) return("#dc3545")
  } else {
    if(change > 0) return("#dc3545")
    if(change < 0) return("#28a745")
  }
  return("#6c757d")
}

# Format change text
format_change <- function(change_obj, use_pp = TRUE) {
  if(is.na(change_obj$change)) return("No data")
  suffix <- ifelse(use_pp, " p.p.", "")
  paste0(get_arrow_icon(change_obj$change), " ",
         abs(round(change_obj$change, 1)), suffix)
}

# Get glow class for single metric
get_glow_class <- function(value, target, is_higher_good = TRUE) {
  if(!SHOW_GLOW_EFFECTS) return("")
  if(is.na(value) || is.na(target)) return("")
  if(is_higher_good) {
    if(value >= target) return("glow-green")
    return("glow-red")
  } else {
    if(value <= target) return("glow-green")
    return("glow-red")
  }
}

# Get glow class for multiple metrics
get_multi_glow_class <- function(values, targets, is_higher_good = TRUE) {
  if(!SHOW_GLOW_EFFECTS) return("")
  if(length(values) == 0 || all(is.na(values)) || all(is.na(targets))) return("")
  
  valid <- !is.na(values) & !is.na(targets)
  if(!any(valid)) return("")
  
  values <- values[valid]
  targets <- targets[valid]
  
  if(is_higher_good) {
    above <- values >= targets
  } else {
    above <- values <= targets
  }
  
  if(all(above)) return("glow-green")
  if(!any(above)) return("glow-red")
  return("glow-yellow")
}

# Get glow class for a chart based on latest values
get_chart_glow_class <- function(data, metrics, is_higher_good = TRUE) {
  if(!SHOW_GLOW_EFFECTS) return("")
  
  latest_date <- max(data$date, na.rm = TRUE)
  latest_data <- data %>% 
    filter(date == latest_date, metric_name %in% metrics)
  
  if(nrow(latest_data) == 0) return("")
  
  values <- latest_data$value_num
  targets <- latest_data$target_num
  
  get_multi_glow_class(values, targets, is_higher_good)
}
```

```{r}
#| label: universal_chart_functions

# Line chart (single or multiple metrics)
create_line_chart <- function(data, metrics, title, show_area = FALSE, 
                              is_higher_good = TRUE, faceted = FALSE) {
  
  plot_data <- data %>%
    filter(metric_name %in% metrics) %>%
    filter(!is.na(value_num)) %>%
    arrange(date)
  
  if(nrow(plot_data) == 0) {
    return(ggplot() +
             annotate("text", x = 0.5, y = 0.5, label = "No data", size = 8, color = "#6c757d") +
             theme_void() +
             labs(title = title))
  }
  
  # Calculate Y limits
  y_min <- min(c(plot_data$value_num, plot_data$target_num), na.rm = TRUE)
  y_max <- max(c(plot_data$value_num, plot_data$target_num), na.rm = TRUE)
  y_range <- y_max - y_min
  y_min <- y_min - y_range * 0.15
  y_max <- y_max + y_range * 0.2
  
  # Colors
  n_metrics <- length(unique(plot_data$metric_name))
  if(n_metrics == 1) {
    colors <- c("#007bff")
    names(colors) <- metrics[1]
  } else {
    colors <- c("#007bff", "#17a2b8", "#28a745", "#ffc107", "#dc3545")[1:n_metrics]
    names(colors) <- unique(plot_data$metric_name)
  }
  
  if(faceted && n_metrics > 1) {
    # Faceted chart
    p <- ggplot(plot_data, aes(x = date, y = value_num)) +
      geom_hline(aes(yintercept = target_num), linetype = "dashed", color = "#6c757d", linewidth = 0.8) +
      geom_line(aes(color = metric_name), linewidth = 1.2) +
      geom_point(aes(color = metric_name), size = 3) +
      geom_text(aes(label = round(value_num, 1)), vjust = -1, size = 3) +
      geom_text(aes(x = min(date), y = target_num, label = paste0("Target: ", target_num)),
                hjust = 0, vjust = -0.5, size = 2.8, color = "#6c757d", check_overlap = TRUE) +
      facet_wrap(~ metric_name, ncol = length(metrics)) +
      scale_color_manual(values = colors) +
      theme_minimal(base_size = 12) +
      theme(legend.position = "none",
            strip.text = element_text(size = 11, face = "bold"))
    
  } else if(n_metrics == 1) {
    # Single line chart
    target_val <- plot_data$target_num[1]
    
    p <- ggplot(plot_data, aes(x = date, y = value_num)) +
      geom_hline(yintercept = target_val, linetype = "dashed", color = "#6c757d", linewidth = 1)
    
    if(show_area) {
      p <- p + geom_area(fill = colors[1], alpha = 0.2)
    }
    
    p <- p +
      annotate("text", x = max(plot_data$date), y = target_val, 
               label = paste0("Target: ", target_val), hjust = 1, vjust = -0.5, 
               color = "#6c757d", size = 3.5) +
      geom_line(color = colors[1], linewidth = 1.2) +
      geom_point(color = colors[1], size = 3) +
      geom_text(aes(label = round(value_num, 1)), vjust = -1, size = 3.5, fontface = "bold")
    
  } else {
    # Multiple lines on same chart
    p <- ggplot(plot_data, aes(x = date, y = value_num, color = metric_name, group = metric_name)) +
      geom_line(linewidth = 1.2) +
      geom_point(size = 3) +
      geom_text(aes(label = round(value_num, 1)), vjust = -1, size = 3, show.legend = FALSE) +
      scale_color_manual(values = colors)
  }
  
  p <- p +
    labs(title = title, x = NULL, y = NULL) +
    theme_minimal(base_size = 12) +
    theme(plot.title = element_text(size = 14, face = "bold"),
          panel.grid.minor = element_blank(),
          plot.margin = margin(10, 15, 10, 10)) +
    scale_y_continuous(limits = c(y_min, y_max))
  
  return(p)
}

# Dual line chart with area between (for Availability)
create_dual_line_area_chart <- function(data, metrics, title) {
  
  if(length(metrics) != 2) {
    stop("Dual line area chart requires exactly 2 metrics")
  }
  
  data1 <- data %>% filter(metric_name == metrics[1]) %>% 
    select(date, val1 = value_num) %>% filter(!is.na(val1))
  data2 <- data %>% filter(metric_name == metrics[2]) %>% 
    select(date, val2 = value_num) %>% filter(!is.na(val2))
  
  plot_data <- data1 %>%
    inner_join(data2, by = "date") %>%
    arrange(date)
  
  if(nrow(plot_data) == 0) {
    return(ggplot() +
             annotate("text", x = 0.5, y = 0.5, label = "No data", size = 8, color = "#6c757d") +
             theme_void() +
             labs(title = title))
  }
  
  # Risk zone (hardcoded for availability, could be configurable)
  risk_threshold <- 35
  
  p <- ggplot(plot_data, aes(x = date)) +
    annotate("rect", xmin = -Inf, xmax = Inf, ymin = 0, ymax = risk_threshold,
             fill = "#dc3545", alpha = 0.15) +
    annotate("text", x = max(plot_data$date), y = risk_threshold - 3,
             label = paste0("Risk Zone (<", risk_threshold, "%)"), 
             hjust = 1, color = "#dc3545", size = 3) +
    geom_ribbon(aes(ymin = val2, ymax = val1), fill = "#007bff", alpha = 0.25) +
    geom_line(aes(y = val1, linetype = "Average"), color = "#007bff", linewidth = 1.2) +
    geom_point(aes(y = val1), color = "#007bff", size = 3) +
    geom_line(aes(y = val2, linetype = "Lowest"), color = "#0056b3", linewidth = 1) +
    geom_point(aes(y = val2), color = "#0056b3", size = 2) +
    geom_text(aes(y = val1, label = paste0(round(val1, 1), "%")), 
              vjust = -0.8, size = 3.5, fontface = "bold") +
    geom_text(aes(y = val2, label = paste0(round(val2, 1), "%")), 
              vjust = 1.5, size = 3, color = "#0056b3") +
    scale_linetype_manual(name = "", values = c("Average" = "solid", "Lowest" = "dashed"),
                          guide = guide_legend(override.aes = list(color = c("#007bff", "#0056b3")))) +
    labs(title = title, x = NULL, y = NULL) +
    theme_minimal(base_size = 12) +
    theme(plot.title = element_text(size = 14, face = "bold"),
          panel.grid.minor = element_blank(),
          legend.position = "bottom",
          plot.margin = margin(10, 15, 10, 10)) +
    scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 10))
  
  return(p)
}

# Grouped bar chart
create_bar_chart <- function(data, metrics, title) {
  
  plot_data <- data %>%
    filter(metric_name %in% metrics) %>%
    filter(!is.na(value_num)) %>%
    arrange(date)
  
  if(nrow(plot_data) == 0) {
    return(ggplot() +
             annotate("text", x = 0.5, y = 0.5, label = "No data", size = 8, color = "#6c757d") +
             theme_void() +
             labs(title = title))
  }
  
  dates_with_data <- unique(plot_data$date)
  n_dates <- length(dates_with_data)
  
  # Colors
  colors <- c("#17a2b8", "#28a745", "#ffc107")
  names(colors) <- metrics
  
  text_colors <- c("#0d5f6e", "#1e7b34", "#8b6914")
  names(text_colors) <- metrics
  
  # Auto-calculate bar width
  if(n_dates > 1) {
    date_range <- as.numeric(max(dates_with_data) - min(dates_with_data))
    bar_width <- date_range / (n_dates + 1) * 0.8
  } else {
    bar_width <- 5
  }
  
  p <- ggplot(plot_data, aes(x = date, y = value_num, fill = metric_name)) +
    geom_bar(stat = "identity", position = position_dodge(width = bar_width * 1.1), width = bar_width) +
    geom_errorbar(aes(ymin = target_num, ymax = target_num, color = metric_name),
                  position = position_dodge(width = bar_width * 1.1), 
                  width = bar_width * 0.85, linewidth = 1.2, linetype = "dashed",
                  show.legend = FALSE) +
    geom_text(aes(label = paste0(round(value_num, 1), "%"), color = metric_name), 
              position = position_dodge(width = bar_width * 1.1), vjust = -0.5, 
              size = 3.2, fontface = "bold", show.legend = FALSE) +
    labs(title = title, x = NULL, y = NULL, fill = "Metric") +
    scale_fill_manual(values = colors) +
    scale_color_manual(values = text_colors) +
    theme_minimal(base_size = 12) +
    theme(plot.title = element_text(size = 14, face = "bold"),
          legend.position = "bottom",
          panel.grid.minor = element_blank(),
          plot.margin = margin(10, 15, 10, 10)) +
    scale_y_continuous(limits = c(0, 105), breaks = seq(0, 100, 10))
  
  return(p)
}
```

```{r}
#| label: kpi_card_generator

create_kpi_card <- function(metric_name, data, is_higher_good = TRUE, show_target = TRUE) {
  
  change_data <- calculate_change(data, metric_name)
  glow_class <- get_glow_class(change_data$current, change_data$target, is_higher_good)
  
  div(class = paste("kpi-box", glow_class),
      div(class = "kpi-label", toupper(metric_name)),
      div(class = "kpi-value", format_metric_value(change_data$current)),
      if(show_target) {
        div(style = "font-size: 12px; color: #6c757d; margin: 5px 0;",
            paste0("Target: ", ifelse(!is.na(change_data$target),
                                      round(change_data$target, 1), "â€”"), "%"))
      },
      div(class = "kpi-change", 
          style = paste0("color: ", get_change_color(change_data$change, is_higher_good)),
          format_change(change_data))
  )
}

create_kpi_card_small <- function(metric_name, data, is_higher_good = TRUE, 
                                  show_target = TRUE, show_badge = FALSE) {
  
  change_data <- calculate_change(data, metric_name)
  glow_class <- get_glow_class(change_data$current, change_data$target, is_higher_good)
  
  # Determine if value is percentage
  is_percent <- grepl("%", metric_name) || metric_name %in% c("Utilization", "PU Retention")
  
  div(class = paste("kpi-box-small", glow_class),
      style = "flex: 1; display: flex; flex-direction: column; justify-content: center;",
      div(class = "kpi-label", toupper(metric_name)),
      div(class = "kpi-value-small", 
          if(is_percent) {
            format_metric_value(change_data$current, add_percent = TRUE, decimal = 1)
          } else {
            ifelse(!is.na(change_data$current), round(change_data$current, 0), "No data")
          }),
      if(show_target && !is.na(change_data$target)) {
        div(style = "font-size: 11px; color: #6c757d;",
            paste0("Target: ", if(!is_higher_good) "â‰¤" else "", change_data$target, 
                   if(is_percent) "%" else ""))
      },
      div(class = "kpi-change", 
          style = paste0("font-size: 12px; color: ", get_change_color(change_data$change, is_higher_good)),
          if(is_percent) {
            format_change(change_data)
          } else {
            ifelse(!is.na(change_data$change), 
                   paste0(get_arrow_icon(change_data$change), " ", abs(round(change_data$change, 0))),
                   "No data")
          }),
      if(show_badge && !is.na(change_data$current) && !is.na(change_data$target)) {
        is_ok <- if(is_higher_good) change_data$current >= change_data$target else change_data$current <= change_data$target
        div(class = paste0("status-badge ", ifelse(is_ok, "status-ok", "status-alert")),
            ifelse(is_ok, "OK", "ALERT"))
      }
  )
}

create_kpi_card_large <- function(metric_name, data, is_higher_good = TRUE) {
  
  change_data <- calculate_change(data, metric_name)
  glow_class <- get_glow_class(change_data$current, change_data$target, is_higher_good)
  
  div(class = paste("chart-box", glow_class), 
      style = "height: 350px; display: flex; flex-direction: column; justify-content: center;",
      h3(metric_name, style = "font-size: 16px; font-weight: 700; margin-bottom: 10px; text-align: center;"),
      div(style = "font-size: 11px; color: #6c757d; text-align: center; margin-bottom: 10px;",
          paste0("Target: ", ifelse(!is.na(change_data$target),
                                    round(change_data$target, 2), "â€”"), "%")),
      if(!is.na(change_data$current)) {
        div(style = "text-align: center;",
            div(class = "kpi-value", format_metric_value(change_data$current, add_percent = TRUE, decimal = 2)),
            div(class = "kpi-change",
                style = paste0("color: ", get_change_color(change_data$change, is_higher_good)),
                format_change(change_data)),
            div(style = "margin-top: 15px; color: #6c757d; font-size: 14px;",
                paste0("Previous: ", format_metric_value(change_data$previous, add_percent = TRUE, decimal = 2)))
        )
      } else {
        div(style = "text-align: center; color: #6c757d; font-size: 18px;", "No data")
      }
  )
}
```

```{r}
#| label: nda/ai_violation_parser

parse_nda_violations <- function(data) {
  nda_data <- data %>%
    filter(metric_name == "NDA & AI usage abuse") %>%
    arrange(desc(date))
  
  result <- list(nda_count = 0, ai_count = 0, nda_prev = 0, ai_prev = 0, total = 0, change = 0)
  
  if(nrow(nda_data) >= 1) {
    val <- nda_data$value_raw[1]
    if(!is.na(val) && val != "N/A") {
      nda_match <- regmatches(val, regexec("NDA - ([0-9]+)", val))
      if(length(nda_match[[1]]) > 1) result$nda_count <- as.numeric(nda_match[[1]][2])
      ai_match <- regmatches(val, regexec("AI abuse - ([0-9]+)", val))
      if(length(ai_match[[1]]) > 1) result$ai_count <- as.numeric(ai_match[[1]][2])
    }
  }
  
  if(nrow(nda_data) >= 2) {
    val <- nda_data$value_raw[2]
    if(!is.na(val) && val != "N/A") {
      nda_match <- regmatches(val, regexec("NDA - ([0-9]+)", val))
      if(length(nda_match[[1]]) > 1) result$nda_prev <- as.numeric(nda_match[[1]][2])
      ai_match <- regmatches(val, regexec("AI abuse - ([0-9]+)", val))
      if(length(ai_match[[1]]) > 1) result$ai_prev <- as.numeric(ai_match[[1]][2])
    }
  }
  
  result$total <- result$nda_count + result$ai_count
  result$change <- (result$nda_count - result$nda_prev) + (result$ai_count - result$ai_prev)
  
  return(result)
}
```

```{r}
#| label: shiny_ui

ui <- fluidPage(
  
  tags$head(
    tags$style(HTML("
      body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
      .main-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
                     padding: 30px; border-radius: 12px; margin-bottom: 20px; }
      .kpi-box { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; 
                 box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: box-shadow 0.3s; }
      .kpi-box.glow-green { box-shadow: 0 0 15px 3px rgba(40, 167, 69, 0.4); border: 1px solid rgba(40, 167, 69, 0.3); }
      .kpi-box.glow-red { box-shadow: 0 0 15px 3px rgba(220, 53, 69, 0.4); border: 1px solid rgba(220, 53, 69, 0.3); }
      .kpi-box.glow-yellow { box-shadow: 0 0 15px 3px rgba(255, 193, 7, 0.5); border: 1px solid rgba(255, 193, 7, 0.4); }
      .kpi-value { font-size: 36px; font-weight: 700; color: #212529; margin: 10px 0; }
      .kpi-label { font-size: 12px; color: #6c757d; font-weight: 600; text-transform: uppercase; }
      .kpi-change { font-size: 14px; font-weight: 600; margin-top: 5px; }
      .kpi-box-small { background: white; padding: 15px; border-radius: 12px; 
                       box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; transition: box-shadow 0.3s; }
      .kpi-box-small.glow-green { box-shadow: 0 0 15px 3px rgba(40, 167, 69, 0.4); border: 1px solid rgba(40, 167, 69, 0.3); }
      .kpi-box-small.glow-red { box-shadow: 0 0 15px 3px rgba(220, 53, 69, 0.4); border: 1px solid rgba(220, 53, 69, 0.3); }
      .kpi-box-small.glow-yellow { box-shadow: 0 0 15px 3px rgba(255, 193, 7, 0.5); border: 1px solid rgba(255, 193, 7, 0.4); }
      .kpi-value-small { font-size: 28px; font-weight: 700; color: #212529; margin: 8px 0; }
      .alert-box { padding: 20px; border-radius: 12px; margin: 20px 0; font-weight: 600; text-align: center; }
      .alert-safe { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
      .alert-danger { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
      .chart-box { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; 
                   box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: box-shadow 0.3s; }
      .chart-box.glow-green { box-shadow: 0 0 15px 3px rgba(40, 167, 69, 0.4); border: 1px solid rgba(40, 167, 69, 0.3); }
      .chart-box.glow-red { box-shadow: 0 0 15px 3px rgba(220, 53, 69, 0.4); border: 1px solid rgba(220, 53, 69, 0.3); }
      .chart-box.glow-yellow { box-shadow: 0 0 15px 3px rgba(255, 193, 7, 0.5); border: 1px solid rgba(255, 193, 7, 0.4); }
      h2 { font-size: 18px; font-weight: 700; color: #212529; margin-bottom: 15px; }
      .status-badge { padding: 8px 20px; border-radius: 20px; display: inline-block; margin-top: 10px; font-weight: 600; }
      .status-ok { background: #d4edda; color: #155724; }
      .status-alert { background: #f8d7da; color: #721c24; }
    "))
  ),
  
  # Header
  div(class = "main-header",
      h1("Supply Metrics Dashboard", style = "margin: 0; font-size: 32px;"),
      p(paste("Last update:", format(last_data_date, "%d.%m.%Y")), 
        style = "margin: 10px 0 0 0; font-size: 14px; opacity: 0.9;")
  ),
  
  # BLOCK 1: Key Metrics
  h2("Key Metrics", style = "margin: 20px 0 15px 0; font-size: 20px; font-weight: 700;"),
  
  fluidRow(
    lapply(BLOCK1_METRICS, function(m) {
      column(3, create_kpi_card(m[1], long_data))
    })
  ),
  
  # BLOCK 2: Operational Metrics
  h2("Operational Metrics"),
  
  fluidRow(
    # Supply Liquidity
    column(5, {
      glow <- get_chart_glow_class(chart_data, c("Availability Average", "Availability Lowest"))
      div(class = paste("chart-box", glow), 
          plotOutput("plot_availability", height = "350px"))
    }),
    # Utilization
    column(4, {
      glow <- get_chart_glow_class(chart_data, c("Utilization"))
      div(class = paste("chart-box", glow), 
          plotOutput("plot_utilization", height = "350px"))
    }),
    # Cards stack
    column(3,
           div(style = "display: flex; flex-direction: column; height: 390px; gap: 10px;",
               create_kpi_card_small("%Rejects", long_data, is_higher_good = FALSE, show_badge = TRUE),
               create_kpi_card_small("Headcount", long_data, show_target = FALSE)
           )
    )
  ),
  
  # BLOCK 3: Quality & Business Metrics
  h2("Quality & Business Metrics"),
  
  fluidRow(
    column(6, {
      glow <- get_chart_glow_class(chart_data, c("CSAT overall", "CSAT trial"))
      div(class = paste("chart-box", glow), style = "height: 350px;", 
          plotOutput("plot_csat", height = "320px"))
    }),
    column(6, create_kpi_card_large("CR Free to Paid", long_data))
  ),
  
  fluidRow(
    column(6, {
      glow <- get_chart_glow_class(chart_data, c("FRT"), is_higher_good = FALSE)
      div(class = paste("chart-box", glow), 
          plotOutput("plot_frt", height = "300px"))
    }),
    column(6, {
      glow <- get_chart_glow_class(chart_data, c("% Positive reviews"))
      div(class = paste("chart-box", glow), 
          plotOutput("plot_reviews", height = "300px"))
    })
  ),
  
  fluidRow(
    column(12, {
      glow <- get_chart_glow_class(chart_data, c("Pings coverage", "Messenger answer rate", "Engagement messages coverage"))
      div(class = paste("chart-box", glow), 
          plotOutput("plot_communication", height = "350px"))
    })
  ),
  
  # BLOCK 4: Risk Alert
  {
    nda <- parse_nda_violations(long_data)
    div(class = ifelse(nda$total > 0, "alert-box alert-danger", "alert-box alert-safe"),
        if(nda$total > 0) {
          div(
            div(style = "font-size: 18px; margin-bottom: 8px;",
                paste0("âš ï¸ ALERT: ", nda$total, " Violations detected")),
            div(style = "font-size: 14px; opacity: 0.9;",
                paste0("NDA: ", nda$nda_count, " | AI Usage: ", nda$ai_count),
                if(nda$change != 0) {
                  span(style = paste0("margin-left: 15px; color: ", 
                                      ifelse(nda$change > 0, "#721c24", "#155724"), ";"),
                       paste0(ifelse(nda$change > 0, "â†‘", "â†“"), " ", abs(nda$change), " vs previous"))
                }
            )
          )
        } else {
          "âœ“ No NDA or AI Usage Violations"
        }
    )
  }
)
```

```{r}
#| label: shiny_server

server <- function(input, output, session) {
  
  output$plot_availability <- renderPlot({
    create_dual_line_area_chart(chart_data, 
                                c("Availability Average", "Availability Lowest"),
                                "Supply Liquidity (Availability)")
  }, res = 96)
  
  output$plot_utilization <- renderPlot({
    create_line_chart(chart_data, "Utilization", "Utilization", show_area = FALSE)
  }, res = 96)
  
  output$plot_csat <- renderPlot({
    create_line_chart(chart_data, c("CSAT overall", "CSAT trial"), "CSAT Metrics", faceted = TRUE)
  }, res = 96)
  
  output$plot_frt <- renderPlot({
    create_line_chart(chart_data, "FRT", "First Response Time (FRT)", is_higher_good = FALSE)
  }, res = 96)
  
  output$plot_reviews <- renderPlot({
    create_line_chart(chart_data, "% Positive reviews", "% Positive Reviews")
  }, res = 96)
  
  output$plot_communication <- renderPlot({
    create_bar_chart(chart_data, 
                     c("Pings coverage", "Messenger answer rate", "Engagement messages coverage"),
                     "Communication Metrics")
  }, res = 96)
}
```

```{r}
#| label: image_generator

generate_dashboard_image <- function(output_dir = "images", filename = NULL, delay = 3) {
  
  # Create output directory if it doesn't exist
  if(!dir.exists(output_dir)) {
    dir.create(output_dir, recursive = TRUE)
    cat("Created directory:", output_dir, "\n")
  }
  
  # Generate filename with date if not provided
  if(is.null(filename)) {
    filename <- paste0("dashboard_", format(Sys.Date(), "%Y-%m-%d"), ".png")
  }
  
  filepath <- file.path(output_dir, filename)
  
  # Check and install webshot2 if needed
  if(!require(webshot2, quietly = TRUE)) {
    cat("Installing webshot2...\n")
    install.packages("webshot2")
    library(webshot2)
  }
  
  cat("Generating dashboard image...\n")
  cat("Starting temporary Shiny server...\n")
  
  # Create the Shiny app object
  app <- shinyApp(ui = ui, server = server)
  
  # Use appshot to capture the dashboard
  webshot2::appshot(
    app = app,
    file = filepath,
    delay = delay,  # Wait for plots to render
    vwidth = 1400,  # Viewport width
    vheight = 2200, # Viewport height
    zoom = 1.5      # Higher resolution
  )
  
  cat("âœ“ Dashboard image saved to:", filepath, "\n")
  return(filepath)
}
```

```{r}
#| label: launch

cat("\n")
cat("==============================================\n")
cat("ðŸš€ SUPPLY DASHBOARD\n")
cat("==============================================\n")
cat("Chart history period:", CHART_HISTORY_MONTHS, "months\n")

# Generate static image
cat("\nðŸ“¸ Generating dashboard screenshot...\n")
image_path <- generate_dashboard_image()

cat("\nðŸŒ Opening interactive dashboard in RStudio Viewer...\n")
cat("To stop, press ESC or Stop\n")
cat("==============================================\n\n")

shinyApp(ui = ui, server = server)
```


## Sending this dashboard to Slack server

```{r setup, include=FALSE}
reticulate::use_virtualenv("./Dashboard", required = TRUE)
```

```{python}
import os
import glob 
from dotenv import load_dotenv
from slack_sdk import WebClient
from slack_sdk.errors import SlackApiError

load_dotenv()

token = os.getenv("SLACK_BOT_TOKEN")
channel_id = os.getenv("CHANNEL_ID")

image_folder = "images"

search_pattern = os.path.join(image_folder, "*.png") 
list_of_files = glob.glob(search_pattern) 

if not list_of_files:
    print(f"ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ°: Ð£ Ð¿Ð°Ð¿Ñ†Ñ– '{image_folder}' Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð¶Ð¾Ð´Ð½Ð¾Ð³Ð¾ PNG Ñ„Ð°Ð¹Ð»Ñƒ!")
    exit()
    
latest_file = max(list_of_files, key=os.path.getmtime)

print(f"âœ… Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð½Ð°Ð¹Ð½Ð¾Ð²Ñ–ÑˆÐµ Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ: {latest_file}")

if not token:
    print("ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ°: Ð¢Ð¾ÐºÐµÐ½ Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾.")
else:
    client = WebClient(token=token)

try:
    response = client.files_upload_v2(
        channel=channel_id,
        file=latest_file, 
        title="Ð¡Ð²Ñ–Ð¶Ð¸Ð¹ Ð·Ð²Ñ–Ñ‚",
        initial_comment=f"ÐžÑÑŒ Ð½Ð°Ð¹Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ–ÑˆÐ¸Ð¹ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´ ({os.path.basename(latest_file)})"
    )
    print("Ð—Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾ Ð½Ð°Ð´Ñ–ÑÐ»Ð°Ð½Ð¾!")

except SlackApiError as e:
    print(f"Error uploading file: {e.response['error']}")
except FileNotFoundError:
    print(f"Ð¤Ð°Ð¹Ð» {latest_file} ÐºÑƒÐ´Ð¸ÑÑŒ Ð·Ð½Ð¸Ðº Ð¿Ñ–Ð´ Ñ‡Ð°Ñ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°.")
```

