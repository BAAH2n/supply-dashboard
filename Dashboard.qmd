---
title: "Dashboard"
format: html
editor: visual
---

```{r}
#| label: load_libraries
#| echo: false
#| warning: false

library(tidyverse)
library(ggplot2)
library(patchwork)
library(stringr)
```

```{r}
#| label: load&transform_data
#| warning: false
#| 
url <- "https://docs.google.com/spreadsheets/d/1DWcT_Qs3a71Um4I--zvMtkl1CnVuHmW05JlYs-WwS8c/edit?gid=0#gid=0"
data <- googlesheets4::read_sheet(url, col_types = "c")

long_data <- data %>% 
  select(-Owner) %>% 
  select(where(~!all(is.na(.)))) %>%
  rename(metric_name = "Metrics/ Date") %>%
  rename(target_raw = Target) %>% 
  pivot_longer(
    cols = -c(metric_name, target_raw),
    names_to = "date",  
    values_to = "value_raw" 
  ) %>%
  mutate(
    value_raw = str_replace(value_raw, ",", "."),
    target_num = parse_number(target_raw),
    value_num = parse_number(value_raw)
  ) %>% 
  select(-target_raw) %>%
  print() %>% 
  view()
```
```{r}
# Функція малювання (шаблон)
draw_card_base <- function(title, value, target, prev_value, suffix = "", invert = FALSE) {
  
  # --- ЗАХИСТ ВІД ПУСТИХ ДАНИХ (NA) ---
  # Якщо значення або таргет пусті, ми не можемо визначити колір.
  # Тому ставимо нейтральний сірий.
  
  if (is.na(value) || is.na(target)) {
    bg_color   <- "#f0f0f0" # Сірий фон
    main_color <- "#7f8c8d" # Сірий текст
    delta_label <- "No Data"
    delta_color <- "grey70"
    
    # Якщо значення немає, замінимо його на прочерк для відображення
    display_value <- "--"
    display_target <- "--"
    
  } else {
    # --- ЯКЩО ДАНІ Є (НОРМАЛЬНИЙ РЕЖИМ) ---
    display_value <- value
    display_target <- target
    
    # Логіка кольору (Good/Bad)
    is_good_status <- if (invert) value <= target else value >= target
    bg_color   <- if (is_good_status) "#e8f8f5" else "#fdedec"
    main_color <- if (is_good_status) "#27ae60" else "#c0392b"
    
    # Логіка дельти
    delta_label <- "=" 
    delta_color <- "grey50"
    
    if (!is.na(prev_value)) {
      diff <- value - prev_value
      arrow <- if (diff > 0) "▲" else if (diff < 0) "▼" else ""
      
      is_good_change <- if (invert) diff <= 0 else diff >= 0
      delta_color <- if (is_good_change) "#27ae60" else "#c0392b"
      
      delta_label <- paste0(arrow, " ", round(diff, 2), suffix)
    }
  }

  # --- МАЛЮВАННЯ ---
  ggplot() +
    annotate("rect", xmin=0, xmax=1, ymin=0, ymax=1, fill=bg_color, color=NA) +
    annotate("text", x=0.5, y=0.6, label=paste0(display_value, suffix), size=10, fontface="bold", color=main_color) +
    annotate("text", x=0.5, y=0.85, label=title, size=4, fontface="bold", color="grey30") +
    annotate("text", x=0.2, y=0.25, label=paste0("Target: ", display_target, suffix), size=3, color="grey50", hjust=0) +
    annotate("text", x=0.8, y=0.25, label=delta_label, size=3.5, fontface="bold", color=delta_color, hjust=1) +
    theme_void() +
    theme(plot.margin = margin(2, 2, 2, 2))
}
```
```{r}
# ==============================================================================
# НАЛАШТУВАННЯ: Які метрики ти хочеш бачити в шапці?
# (Пиши назви точно так, як вони в тебе в Excel/таблиці long_data)
# ==============================================================================
my_metrics <- c("Availability Average", "Availability Lowest", "%Completion", "PU Retention")

# ==============================================================================
# АВТОМАТИЧНИЙ ГЕНЕРАТОР
# ==============================================================================

# Проходимось по списку метрик і створюємо графіки
plots_list <- lapply(my_metrics, function(m_name) {
  
  # 1. Фільтруємо дані для конкретної метрики
  subset <- long_data %>% 
    filter(metric_name == m_name) %>% 
    arrange(date) # Сортуємо, щоб остання дата була в кінці
  
  # Якщо метрику не знайдено - повертаємо пустий квадрат (щоб не ламало код)
  if (nrow(subset) == 0) return(ggplot() + theme_void())
  
  # 2. Беремо свіжу і попередню дату
  curr_row <- tail(subset, 1)          # Остання
  prev_row <- tail(subset, 2) %>% head(1) # Передостання
  
  # 3. Визначаємо налаштування (suffix та invert) автоматично
  # Тут проста логіка: якщо в назві є "%" або це Utilization - додаємо %.
  # Якщо це FRT або Rejects - інвертуємо кольори (менше=краще).
  
  my_suffix <- case_when(
    str_detect(m_name, "%|Availability|Rate|Coverage|PU") ~ "%",
    m_name == "FRT" ~ "m",
    TRUE ~ ""
  )
  
  should_invert <- case_when(
    str_detect(m_name, "FRT|Rejects|Abuse") ~ TRUE,
    TRUE ~ FALSE
  )
  
  # Чистимо заголовок для краси (UPPERCASE, без %)
  clean_title <- m_name %>% str_replace_all("%", "") %>% toupper()
  
  # 4. Малюємо
  draw_card_base(
    title      = clean_title,
    value      = curr_row$value_num,
    target     = curr_row$target_num,
    prev_value = prev_row$value_num,
    suffix     = my_suffix,
    invert     = should_invert
  )
})

# ==============================================================================
# ЗБІРКА ДАШБОРДУ (ХЕДЕР)
# ==============================================================================

# wrap_plots автоматично склеює список графіків
dashboard_header <- wrap_plots(plots_list, nrow = 1)

# Виводимо результат
dashboard_header
```
```{r}

# ==============================================================================
# 1. УНІВЕРСАЛЬНА ФУНКЦІЯ ДЛЯ ГРАФІКІВ (РІВЕНЬ 2 і 3)
# ==============================================================================
draw_trend_chart <- function(data, metric_excel_name, plot_title, 
                             color_line = "#2980b9", suffix = "", 
                             y_limits = NULL) {
  
  # Фільтруємо дані
  plot_data <- data %>% 
    filter(metric_name == metric_excel_name) %>% 
    arrange(date) # Гарантуємо порядок дат
  
  # Якщо даних немає, повертаємо пустий квадрат
  if(nrow(plot_data) == 0) return(ggplot() + theme_void())
  
  # Отримуємо таргет (беремо останній відомий, щоб намалювати лінію)
  target_val <- tail(plot_data$target_num, 1)
  
  ggplot(plot_data, aes(x = date, y = value_num, group = 1)) +
    
    # 1. Лінія Таргету (Пунктирна)
    geom_hline(yintercept = target_val, linetype = "dashed", color = "red", alpha = 0.6) +
    # Підпис таргету збоку (опціонально, щоб не забути що це)
    annotate("text", x = 1, y = target_val, label = paste("Target:", target_val, suffix), 
             vjust = -0.5, hjust = 0, color = "red", size = 3, fontface = "italic") +

    # 2. Фактична лінія (Жирна суцільна)
    geom_line(color = color_line, size = 1.2) +
    
    # 3. Точки на лінії
    geom_point(color = color_line, size = 3) +
    geom_point(color = "white", size = 1.5) + # Біла цятка всередині для краси
    
    # 4. Значення над кожною точкою (Чітко, як просив)
    geom_text(aes(label = paste0(value_num, suffix)), 
              vjust = -1.2, # Підняти над точкою
              fontface = "bold", size = 3.5, color = "black") +
    
    # Налаштування осей
    scale_y_continuous(limits = y_limits) + # Можна жорстко задати межі (наприклад 0-100%)
    labs(title = plot_title, x = NULL, y = NULL) +
    
    # Чистий дизайн
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", size = 11, color = "#2c3e50"),
      panel.grid.minor = element_blank(),
      panel.grid.major.x = element_blank(), # Прибираємо вертикальну сітку, щоб не заважала датам
      axis.text.y = element_blank(),        # Прибираємо цифри зліва (бо вони вже є над точками!)
      axis.text.x = element_text(face = "bold", size = 10) # Дати знизу жирним
    )
}

# ==============================================================================
# 2. РІВЕНЬ 1: HEADER (Ключові метрики)
# ==============================================================================
# Використовуємо твій список: Avail Avg, Avail Low, Completion, Retention
header_metrics <- c("Availability Average", "Availability Lowest", "%Completion", "PU Retention")

# Генеруємо картки (використовуючи make_card_auto з минулого уроку)
# Якщо ти не зберіг ту функцію, напиши "+", я продублюю. Припускаю, вона є.
cards_list <- lapply(header_metrics, function(m) {
  # Визначаємо суфікс (%)
  suf <- if(str_detect(m, "Retention|Completion|Availability")) "%" else ""
  # Скорочуємо назву для краси
  tit <- case_when(
    m == "Availability Average" ~ "AVAILABILITY (AVG)",
    m == "Availability Lowest" ~ "AVAILABILITY (LOW)",
    TRUE ~ toupper(str_replace(m, "%", ""))
  )
  
  # Ця функція має бути визначена у тебе в коді (див. попереднє повідомлення)
  make_card_auto(long_data, m, tit, suffix = suf)
})

header_plot <- wrap_plots(cards_list, nrow = 1)


# ==============================================================================
# 3. РІВЕНЬ 2: ОПЕРАЦІЙНІ ГРАФІКИ (Utilization)
# ==============================================================================

# Графік 1: Utilization
# y_limits = c(0, 60) означає, що вісь Y буде від 0% до 60% (щоб графік не скакав)
p_util <- draw_trend_chart(long_data, "Utilization", "UTILIZATION TREND", 
                           color_line = "#8e44ad", suffix = "%", y_limits = c(0, 60))


# ==============================================================================
# 4. РІВЕНЬ 3: ЯКІСТЬ ТА БІЗНЕС (CSAT & Conversion)
# ==============================================================================

# Блок 1: CSAT (Overall та Trial)
p_csat_ov <- draw_trend_chart(long_data, "CSAT overall", "CSAT OVERALL", 
                              color_line = "#27ae60", y_limits = c(3, 5))

p_csat_tr <- draw_trend_chart(long_data, "CSAT trial", "CSAT TRIAL", 
                              color_line = "#2ecc71", y_limits = c(3, 5))

# Блок 2: Конверсія (CR Free -> Paid)
p_cr <- draw_trend_chart(long_data, "CR Free to Paid", "CONVERSION (Free -> Paid)", 
                         color_line = "#e67e22", suffix = "%", y_limits = c(0, 10))


# ==============================================================================
# 5. ЗБИРАЄМО ДАШБОРД РАЗОМ
# ==============================================================================

layout_design <- "
AAAA
BBBB
CCDD
"
# A - Header
# B - Utilization (Wide)
# C - CSATs (Left bottom)
# D - CR (Right bottom) - Але у нас два CSAT, тому треба трохи хитріше

# Давай зробимо так: 
# Рядок 1: Header
# Рядок 2: Utilization
# Рядок 3: Три графіки в ряд (CSAT Ov | CSAT Tr | CR)

final_dashboard <- header_plot / 
                   p_util / 
                   (p_csat_ov | p_csat_tr | p_cr) + 
                   plot_layout(heights = c(1, 2, 2)) # Хедер вузький, графіки високі

# Малюємо
final_dashboard
```
```{r}
# ==============================================================================
# ЧАСТИНА 1: ФУНКЦІЇ МАЛЮВАННЯ (Двигун)
# ==============================================================================

# 1. Функція для KPI Картки (Header)
draw_kpi_card <- function(data, metric_name, suffix = "", invert = FALSE) {
  
  # Фільтруємо метрику
  subset <- data %>% 
    filter(metric_name == !!metric_name) %>% 
    arrange(date)
  
  # Якщо даних немає - повертаємо пустий блок
  if(nrow(subset) == 0) return(ggplot() + theme_void())
  
  # Беремо поточне і попереднє значення
  curr_row <- tail(subset, 1)
  prev_row <- tail(subset, 2) %>% head(1)
  
  val    <- curr_row$value_num
  target <- curr_row$target_num
  # Перевірка, чи є попереднє значення (щоб не впало на першій даті)
  p_val  <- if(nrow(subset) > 1) prev_row$value_num else NA
  
  # Логіка кольорів
  if (is.na(val) || is.na(target)) {
    bg_col <- "#f0f0f0"; txt_col <- "#95a5a6"; delta_lbl <- "--"; delta_col <- "grey50"
  } else {
    is_good <- if(invert) val <= target else val >= target
    bg_col  <- if(is_good) "#e8f8f5" else "#fdedec"
    txt_col <- if(is_good) "#27ae60" else "#c0392b"
    
    delta_lbl <- ""
    delta_col <- "grey50"
    
    if(!is.na(p_val)) {
      diff <- val - p_val
      arrow <- if(diff > 0) "▲" else if(diff < 0) "▼" else ""
      # Логіка для дельти: якщо invert=TRUE, то "+" це погано
      is_good_change <- if(invert) diff <= 0 else diff >= 0
      delta_col <- if(is_good_change) "#27ae60" else "#c0392b"
      delta_lbl <- paste0(arrow, " ", round(diff, 2), suffix)
    }
  }
  
  clean_title <- toupper(str_replace_all(metric_name, "%", ""))
  
  ggplot() +
    annotate("rect", xmin=0, xmax=1, ymin=0, ymax=1, fill=bg_col, color=NA) +
    annotate("text", x=0.5, y=0.6, label=paste0(val, suffix), size=10, fontface="bold", color=txt_col) +
    annotate("text", x=0.5, y=0.85, label=clean_title, size=3.5, fontface="bold", color="grey30") +
    annotate("text", x=0.2, y=0.2, label=paste0("Target: ", target, suffix), size=3, color="grey50", hjust=0) +
    annotate("text", x=0.8, y=0.2, label=delta_lbl, size=3.5, fontface="bold", color=delta_col, hjust=1) +
    theme_void() +
    theme(plot.margin = margin(2, 2, 2, 2))
}

# 2. Функція для Графіків (Line Chart + Target + Labels)
draw_trend_chart <- function(data, metric_name, suffix = "", color_line = "#2980b9") {
  
  plot_data <- data %>% 
    filter(metric_name == !!metric_name) %>% 
    arrange(date)
  
  if(nrow(plot_data) == 0) return(ggplot() + theme_void())
  
  clean_title <- toupper(metric_name)
  
  ggplot(plot_data, aes(x = date, y = value_num, group = 1)) +
    # Пунктирна лінія таргету
    geom_line(aes(y = target_num), linetype = "dashed", color = "red", alpha = 0.5) +
    
    # Основна лінія
    geom_line(color = color_line, size = 1.2) +
    geom_point(color = color_line, size = 3) +
    geom_point(color = "white", size = 1.5) +
    
    # Підписи значень над точками
    geom_text(aes(label = paste0(value_num, suffix)), 
              vjust = -1.2, fontface = "bold", size = 3.5) +
    
    # Оформлення
    labs(title = clean_title, x = NULL, y = NULL) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", size = 11, color = "#2c3e50"),
      panel.grid.minor = element_blank(),
      panel.grid.major.x = element_blank(),
      axis.text.y = element_blank(),
      axis.text.x = element_text(face = "bold", size = 10)
    )
}

# ==============================================================================
# ЧАСТИНА 2: КОНФІГУРАЦІЯ (Тут ти додаєш нові метрики)
# ==============================================================================

dashboard_config <- list(
  
  # Рівень 1: Картки в шапці
  header = c(
    "Availability Average", 
    "Availability Lowest", 
    "%Completion", 
    "PU Retention"
  ),
  
  # Рівень 2: Основні графіки (Широкі)
  section_main = c(
    "Utilization"
  ),
  
  # Рівень 3: Другорядні графіки (В ряд)
  section_secondary = c(
    "CSAT overall", 
    "CSAT trial", 
    "CR Free to Paid"
  )
)

# ==============================================================================
# ЧАСТИНА 3: АВТОМАТИЧНА ЗБІРКА
# ==============================================================================

# 1. Генеруємо Header
header_plots <- lapply(dashboard_config$header, function(m) {
  # Авто-налаштування
  suf <- if(str_detect(m, "%|Rate|Retention|Availability")) "%" else ""
  should_invert <- str_detect(m, "FRT|Rejects|Abuse") 
  
  draw_kpi_card(long_data, m, suffix = suf, invert = should_invert)
})

# 2. Генеруємо Графіки
# Функція-допомогач для графіків
make_chart_list <- function(metrics_list) {
  lapply(metrics_list, function(m) {
    # Авто-колір
    col <- case_when(
      str_detect(m, "CSAT") ~ "#27ae60",       # Зелений
      str_detect(m, "CR|Retention") ~ "#e67e22", # Помаранчевий
      str_detect(m, "FRT|Rejects") ~ "#c0392b",  # Червоний
      str_detect(m, "Utilization") ~ "#8e44ad",  # Фіолетовий
      TRUE ~ "#2980b9"                         # Синій
    )
    suf <- if(str_detect(m, "%|Rate|Conversion|Utilization")) "%" else ""
    
    draw_trend_chart(long_data, m, suffix = suf, color_line = col)
  })
}

main_charts <- make_chart_list(dashboard_config$section_main)
sec_charts  <- make_chart_list(dashboard_config$section_secondary)

# 3. Фінальна склейка (Layout)
# Хедер в один рядок
blk_header <- wrap_plots(header_plots, nrow = 1)

# Основні графіки - один під одним
blk_main   <- wrap_plots(main_charts, ncol = 1)

# Другорядні - авто-сітка
blk_sec    <- wrap_plots(sec_charts, ncol = if(length(sec_charts) > 2) 3 else 2)

# Компонування
final_dashboard <- blk_header / 
                   blk_main / 
                   blk_sec + 
                   plot_layout(heights = c(1, 2, 2))

# 4. Вивід
final_dashboard
```

